<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoiceGuard ‚Äî Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --bg:#060910;--surface:#0d1117;--s2:#111820;--border:#1a2535;
      --green:#00e5a0;--g10:#00e5a010;--g15:#00e5a015;--g40:#00e5a040;
      --red:#ff4560;--r10:#ff456010;--yellow:#f5c518;
      --text:#e2e8f0;--muted:#4a5568;
      --mono:'Space Mono',monospace;--sans:'Syne',sans-serif
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden}
    .grid-bg{position:fixed;inset:0;z-index:0;
      background:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
      background-size:52px 52px;
      mask-image:radial-gradient(ellipse 80% 50% at 50% 0%,black 30%,transparent 100%);
      -webkit-mask-image:radial-gradient(ellipse 80% 50% at 50% 0%,black 30%,transparent 100%);
      opacity:.2}

    /* NAV */
    .topnav{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:rgba(6,9,16,.9);border-bottom:1px solid var(--border);backdrop-filter:blur(12px)}
    .nav-logo{font-family:var(--sans);font-size:1.1rem;font-weight:800;letter-spacing:-1px;color:var(--text)}
    .nav-logo span{color:var(--green)}
    .nav-user{display:flex;align-items:center;gap:10px}
    .user-pill{display:flex;align-items:center;gap:7px;background:var(--g10);border:1px solid var(--g40);border-radius:100px;padding:5px 12px;font-family:var(--mono);font-size:.72rem;color:var(--green)}
    .user-dot{width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 2s infinite;flex-shrink:0}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.8)}}
    .logout-btn{padding:6px 14px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--muted);font-family:var(--mono);font-size:.7rem;letter-spacing:1px;cursor:pointer;transition:all .2s}
    .logout-btn:hover{border-color:var(--red);color:var(--red)}

    /* CONTAINER */
    .container{position:relative;z-index:1;max-width:940px;margin:0 auto;padding:0 24px 60px}

    /* HEADER */
    header{text-align:center;padding:48px 24px 28px}
    .live-badge{display:inline-flex;align-items:center;gap:7px;background:var(--g10);border:1px solid var(--g40);border-radius:100px;padding:5px 14px;font-family:var(--mono);font-size:.68rem;color:var(--green);letter-spacing:3px;margin-bottom:16px;animation:fadeDown .5s ease both}
    .live-badge::before{content:'';width:6px;height:6px;background:var(--green);border-radius:50%;animation:pulse 2s infinite;flex-shrink:0}
    header h1{font-size:clamp(2.2rem,5.5vw,3.8rem);font-weight:800;letter-spacing:-2px;line-height:1;animation:fadeDown .5s .1s ease both}
    header h1 span{color:var(--green)}
    .subtitle{margin-top:10px;font-family:var(--mono);font-size:.85rem;color:var(--muted);animation:fadeDown .5s .2s ease both}
    @keyframes fadeDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* STATS */
    .stats-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:28px 0;animation:fadeUp .5s .25s ease both}
    .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 12px;text-align:center;transition:border-color .2s,transform .2s}
    .stat-card:hover{border-color:var(--g40);transform:translateY(-2px)}
    .stat-card .num{font-family:var(--mono);font-size:1.7rem;font-weight:700;color:var(--green);line-height:1}
    .stat-card .label{font-size:.65rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-top:5px;font-family:var(--mono)}

    /* TABS */
    .tabs{display:flex;gap:3px;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:4px;margin-bottom:18px;animation:fadeUp .5s .3s ease both}
    .tab-btn{flex:1;padding:10px 6px;border:none;border-radius:9px;background:transparent;color:var(--muted);font-family:var(--mono);font-size:.72rem;letter-spacing:.5px;cursor:pointer;transition:all .2s;white-space:nowrap}
    .tab-btn.active{background:var(--green);color:#000;font-weight:700}
    .tab-btn:not(.active):hover{color:var(--text);background:var(--s2)}

    /* PANELS */
    .panel{display:none;animation:fadeUp .3s ease both}
    .panel.active{display:block}

    /* UPLOAD ZONE */
    .upload-zone{border:2px dashed var(--border);border-radius:16px;padding:44px 24px;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface);position:relative;overflow:hidden}
    .upload-zone::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(0,229,160,.04),transparent 70%);opacity:0;transition:opacity .3s}
    .upload-zone:hover,.upload-zone.dragover{border-color:var(--green);background:var(--s2)}
    .upload-zone:hover::after,.upload-zone.dragover::after{opacity:1}
    .upload-icon{font-size:2.8rem;margin-bottom:10px;display:block}
    .upload-zone h3{font-size:1rem;font-weight:600;margin-bottom:5px}
    .upload-zone p{font-size:.78rem;color:var(--muted);font-family:var(--mono)}
    .file-chosen{margin-top:10px;font-family:var(--mono);font-size:.75rem;color:var(--green);background:var(--g10);padding:6px 12px;border-radius:7px;border:1px solid var(--g40);display:none}

    /* WAVEFORM */
    .waveform-container{display:none;margin-top:12px;border-radius:8px;overflow:hidden;border:1px solid var(--border);background:var(--bg);height:56px}
    canvas.waveform{width:100%;height:56px;display:block}

    /* LOADING */
    .loading-bar{display:none;margin-top:12px;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
    .loading-bar.active{display:block}
    .loading-bar::after{content:'';display:block;height:100%;width:40%;background:var(--green);border-radius:2px;animation:loadSlide 1.2s ease-in-out infinite}
    @keyframes loadSlide{0%{transform:translateX(-250%)}100%{transform:translateX(350%)}}
    .loading-text{display:none;margin-top:8px;font-family:var(--mono);font-size:.72rem;color:var(--muted);text-align:center}
    .loading-text.active{display:block}

    /* BUTTONS */
    .action-btn{width:100%;margin-top:14px;padding:15px;background:var(--green);color:#000;border:none;border-radius:12px;font-family:var(--mono);font-size:.88rem;font-weight:700;letter-spacing:2px;cursor:pointer;transition:all .2s;text-transform:uppercase}
    .action-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 8px 24px var(--g40)}
    .action-btn:disabled{background:var(--s2);color:var(--muted);cursor:not-allowed;box-shadow:none;transform:none}
    .outline-btn{width:100%;margin-top:10px;padding:12px;border-radius:10px;background:transparent;font-family:var(--mono);font-size:.78rem;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all .2s}
    .green .outline-btn{border:1px solid var(--g40);color:var(--green)}
    .red .outline-btn{border:1px solid rgba(255,69,96,.4);color:var(--red)}
    .yellow .outline-btn{border:1px solid rgba(245,197,24,.4);color:var(--yellow)}
    .outline-btn:hover{opacity:.8}

    /* RESULT CARD */
    .result-card{display:none;margin-top:18px;border-radius:16px;padding:24px;border:1px solid;animation:popIn .35s cubic-bezier(.175,.885,.32,1.275) both}
    @keyframes popIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    .result-card.green{background:var(--g15);border-color:var(--g40)}
    .result-card.red{background:var(--r10);border-color:rgba(255,69,96,.4)}
    .result-card.yellow{background:rgba(245,197,24,.05);border-color:rgba(245,197,24,.4)}
    .verdict-row{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:18px}
    .verdict-badge{display:flex;align-items:center;gap:10px}
    .vicon{font-size:1.7rem}
    .vtext h2{font-size:1rem;font-weight:800}
    .vtext p{font-size:.72rem;color:var(--muted);font-family:var(--mono);margin-top:2px}
    .green .vtext h2{color:var(--green)}
    .red .vtext h2{color:var(--red)}
    .yellow .vtext h2{color:var(--yellow)}
    .risk-pill{font-family:var(--mono);font-size:.68rem;font-weight:700;letter-spacing:2px;padding:5px 12px;border-radius:100px}
    .green .risk-pill{background:var(--g10);color:var(--green)}
    .red .risk-pill{background:var(--r10);color:var(--red)}
    .yellow .risk-pill{background:rgba(245,197,24,.1);color:var(--yellow)}
    .conf-section{margin-bottom:18px}
    .conf-labels{display:flex;justify-content:space-between;font-family:var(--mono);font-size:.68rem;color:var(--muted);margin-bottom:5px}
    .conf-labels span:last-child{color:var(--text);font-weight:700}
    .conf-track{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
    .conf-fill{height:100%;border-radius:3px;width:0%;transition:width 1s cubic-bezier(.4,0,.2,1)}
    .green .conf-fill{background:var(--green)}
    .red .conf-fill{background:var(--red)}
    .yellow .conf-fill{background:var(--yellow)}
    .meta-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
    .meta-item{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    .mk{font-family:var(--mono);font-size:.6rem;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
    .mv{font-family:var(--mono);font-size:.72rem;color:var(--text);font-weight:700;margin-top:2px;word-break:break-all}

    /* SUCCESS CARD */
    .success-card{display:none;margin-top:18px;background:var(--g15);border:1px solid var(--g40);border-radius:16px;padding:28px;text-align:center;animation:popIn .35s cubic-bezier(.175,.885,.32,1.275) both}
    .big-check{font-size:2.8rem;margin-bottom:8px}
    .success-card h2{color:var(--green);font-size:1.1rem;margin-bottom:6px}
    .success-card p{color:var(--muted);font-size:.78rem;font-family:var(--mono)}

    /* RECORD PANEL */
    .record-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;display:flex;flex-direction:column;align-items:center;gap:16px}
    .panel-intro{font-size:.85rem;color:var(--muted);font-family:var(--mono);text-align:center}
    .big-mic-wrap{display:flex;justify-content:center}
    .big-mic-ring{position:relative;width:160px;height:160px;display:flex;align-items:center;justify-content:center}
    .big-ring-svg{position:absolute;inset:0;width:100%;height:100%;transform:rotate(-90deg)}
    .big-ring-track{fill:none;stroke:var(--border);stroke-width:5}
    .big-ring-fill{fill:none;stroke:var(--green);stroke-width:5;stroke-linecap:round;stroke-dasharray:452.4;stroke-dashoffset:452.4;transition:stroke-dashoffset .1s linear}
    .big-mic-btn{width:100px;height:100px;border-radius:50%;background:var(--s2);border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .25s;font-size:2.4rem;position:relative;z-index:1}
    .big-mic-btn:hover{border-color:var(--green);background:var(--g10)}
    .big-mic-btn.recording{background:#1a0008;border-color:var(--red);animation:bigPulse 1s ease-in-out infinite}
    .big-mic-btn.done{background:var(--g10);border-color:var(--green)}
    @keyframes bigPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,69,96,.4)}50%{box-shadow:0 0 0 18px rgba(255,69,96,0)}}
    .rec-time{font-family:var(--mono);font-size:1.4rem;color:var(--text);font-weight:700}
    .rec-hint{font-family:var(--mono);font-size:.75rem;color:var(--muted);text-align:center}
    .live-wave{width:100%;height:48px;border-radius:8px;display:none;border:1px solid var(--border);background:var(--bg)}
    .record-actions{width:100%}
    .record-actions .action-btn{margin-top:0}
    .rec-btn-row{display:flex;gap:10px;margin-top:10px}
    .rec-btn-row .action-btn{flex:1;margin-top:0}
    .rec-btn-row .outline-btn{flex:0.5;margin-top:0;border:1px solid var(--border);color:var(--muted)}

    /* HISTORY */
    .history-wrap{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden}
    .htable{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:.73rem}
    .htable th{text-align:left;padding:10px 14px;color:var(--muted);letter-spacing:1px;border-bottom:1px solid var(--border);font-size:.62rem;text-transform:uppercase}
    .htable td{padding:0;border-bottom:1px solid rgba(26,37,53,.5)}
    .htable tr:last-child td{border-bottom:none}
    .hrow-main{display:grid;grid-template-columns:2fr 1.6fr 80px 70px 90px 80px;align-items:center;padding:11px 14px;gap:8px;cursor:pointer;transition:background .15s}
    .hrow-main:hover{background:var(--s2)}
    .verdict-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:100px;font-size:.62rem;font-weight:700;letter-spacing:1px}
    .verdict-pill.ok{background:var(--g10);color:var(--green)}
    .verdict-pill.bad{background:var(--r10);color:var(--red)}
    .play-btn{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border-radius:7px;background:var(--s2);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:.68rem;cursor:pointer;transition:all .2s;white-space:nowrap}
    .play-btn:hover{border-color:var(--green);color:var(--green)}
    .play-btn.playing{background:var(--g10);border-color:var(--green);color:var(--green)}
    .player-row{display:none;padding:0 14px 14px;background:var(--s2);border-top:1px solid rgba(26,37,53,.4)}
    .player-row.open{display:block}
    .audio-player{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-top:2px}
    .player-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .player-fname{font-family:var(--mono);font-size:.72rem;color:var(--green)}
    .player-dur{font-family:var(--mono);font-size:.65rem;color:var(--muted)}
    .player-ctrl{display:flex;align-items:center;gap:10px}
    .ctrl-btn{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--surface);color:var(--text);cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
    .ctrl-btn:hover{border-color:var(--green);color:var(--green)}
    .ctrl-btn.main{width:38px;height:38px;background:var(--green);color:#000;border-color:var(--green);font-size:1rem}
    .ctrl-btn.main:hover{opacity:.85}
    .prog-area{flex:1}
    .prog-wrap{position:relative;height:4px;background:var(--border);border-radius:2px;cursor:pointer;margin-bottom:5px}
    .prog-fill{height:100%;background:var(--green);border-radius:2px;width:0%;pointer-events:none}
    .prog-thumb{position:absolute;top:50%;width:10px;height:10px;background:var(--green);border-radius:50%;transform:translate(-50%,-50%);left:0%;pointer-events:none;box-shadow:0 0 6px var(--g40)}
    .time-row{display:flex;justify-content:space-between;font-family:var(--mono);font-size:.62rem;color:var(--muted)}
    .vol-wrap{display:flex;align-items:center;gap:5px;font-size:.8rem}
    input[type=range].vol-slider{-webkit-appearance:none;appearance:none;width:64px;height:3px;background:var(--border);border-radius:2px;cursor:pointer}
    input[type=range].vol-slider::-webkit-slider-thumb{-webkit-appearance:none;width:10px;height:10px;background:var(--green);border-radius:50%}

    /* HOW IT WORKS */
    .how-section{margin:40px 0;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px}
    .section-label{font-family:var(--mono);font-size:.7rem;color:var(--muted);letter-spacing:3px;text-transform:uppercase;margin-bottom:20px}
    .steps{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .step{padding:16px;background:var(--bg);border:1px solid var(--border);border-radius:10px;transition:border-color .2s}
    .step:hover{border-color:var(--g40)}
    .step-num{font-family:var(--mono);font-size:.62rem;color:var(--green);letter-spacing:2px;margin-bottom:8px}
    .step h4{font-size:.88rem;font-weight:700;margin-bottom:5px}
    .step p{font-size:.74rem;color:var(--muted);line-height:1.55}

    /* TOAST */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px 18px;font-family:var(--mono);font-size:.78rem;color:var(--text);z-index:999;transition:transform .3s ease;white-space:nowrap}
    .toast.show{transform:translateX(-50%) translateY(0)}

    /* FOOTER */
    footer{text-align:center;padding:28px 24px;font-family:var(--mono);font-size:.65rem;color:var(--muted);border-top:1px solid var(--border);margin-top:48px}
    footer span{color:var(--green)}

    /* RESPONSIVE */
    @media(max-width:640px){
      .stats-bar{grid-template-columns:repeat(2,1fr)}
      .meta-grid{grid-template-columns:repeat(2,1fr)}
      .steps{grid-template-columns:1fr}
      .hrow-main{grid-template-columns:1fr 1fr}
      .tabs{flex-wrap:wrap}
      .tab-btn{font-size:.65rem;padding:8px 4px}
      .rec-btn-row{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="grid-bg"></div>

  <nav class="topnav">
    <div class="nav-logo">üîê VOICE<span>GUARD</span></div>
    <div class="nav-user">
      <div class="user-pill">
        <span class="user-dot"></span>
        <span id="userLabel">Loading‚Ä¶</span>
      </div>
      <button class="logout-btn" onclick="doLogout()">LOGOUT</button>
    </div>
  </nav>

  <div class="container">
    <header>
      <div class="live-badge">LIVE SYSTEM</div>
      <h1>VOICE<span>GUARD</span></h1>
      <p class="subtitle">// FFT-Based Audio Authentication &amp; Watermarking System</p>
    </header>

    <div class="stats-bar">
      <div class="stat-card"><div class="num" id="statScans">0</div><div class="label">Files Scanned</div></div>
      <div class="stat-card"><div class="num" id="statFlagged">0</div><div class="label">Threats Detected</div></div>
      <div class="stat-card"><div class="num" id="statAuth">0</div><div class="label">Authenticated</div></div>
      <div class="stat-card"><div class="num" id="statProtected">0</div><div class="label">Files Protected</div></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('detect',this)">üîç DETECT</button>
      <button class="tab-btn" onclick="switchTab('record',this)">üé§ RECORD</button>
      <button class="tab-btn" onclick="switchTab('protect',this)">üîê PROTECT</button>
      <button class="tab-btn" onclick="switchTab('history',this)">üìã HISTORY</button>
    </div>

    <!-- ‚ïê‚ïê‚ïê DETECT PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel active" id="panel-detect">
      <div class="upload-zone" id="detectZone"
        onclick="document.getElementById('detectInput').click()"
        ondragover="handleDragOver(event,'detectZone')"
        ondragleave="handleDragLeave('detectZone')"
        ondrop="handleDrop(event,'detectInput','detectZone')">
        <span class="upload-icon">üéµ</span>
        <h3>Drop audio here or click to upload</h3>
        <p>WAV ¬∑ MP3 ¬∑ OGG ¬∑ FLAC ¬∑ M4A supported</p>
        <input type="file" id="detectInput" accept="audio/*" style="display:none"
          onchange="onFileChosen('detectInput','detectFileLabel','detectAnalyzeBtn','detectWave')"/>
        <div class="file-chosen" id="detectFileLabel"></div>
      </div>
      <div class="waveform-container" id="detectWaveWrap">
        <canvas class="waveform" id="detectWave"></canvas>
      </div>
      <div class="loading-bar" id="detectLoader"></div>
      <p class="loading-text" id="detectLoaderTxt">Applying FFT analysis‚Ä¶</p>
      <button class="action-btn" id="detectAnalyzeBtn" disabled onclick="runDetect()">ANALYZE AUDIO</button>
      <div class="result-card" id="detectResult">
        <div class="verdict-row">
          <div class="verdict-badge">
            <div class="vicon" id="rIcon"></div>
            <div class="vtext"><h2 id="rVerdict"></h2><p id="rRiskLabel"></p></div>
          </div>
          <div class="risk-pill" id="rRisk"></div>
        </div>
        <div class="conf-section">
          <div class="conf-labels"><span>CONFIDENCE</span><span id="rConf"></span></div>
          <div class="conf-track"><div class="conf-fill" id="rConfFill"></div></div>
        </div>
        <div class="meta-grid">
          <div class="meta-item"><div class="mk">File</div><div class="mv" id="rFile"></div></div>
          <div class="meta-item"><div class="mk">Duration</div><div class="mv" id="rDuration"></div></div>
          <div class="meta-item"><div class="mk">FFT Score</div><div class="mv" id="rScore"></div></div>
        </div>
        <button class="outline-btn" onclick="downloadReport()">üìÑ DOWNLOAD FORENSIC REPORT</button>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê RECORD PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-record">
      <div class="record-panel">
        <p class="panel-intro">Record your voice directly ‚Äî no file upload needed</p>
        <div class="big-mic-wrap">
          <div class="big-mic-ring" id="bigMicRing">
            <button class="big-mic-btn" id="bigMicBtn" onclick="toggleLiveRecord()">
              <span id="bigMicIcon">üéôÔ∏è</span>
            </button>
            <svg class="big-ring-svg" viewBox="0 0 160 160">
              <circle class="big-ring-track" cx="80" cy="80" r="72"/>
              <circle class="big-ring-fill" id="bigRingFill" cx="80" cy="80" r="72"/>
            </svg>
          </div>
        </div>
        <p class="rec-time" id="recTimeDisplay">0.0s</p>
        <p class="rec-hint" id="recHint">Click to start recording</p>
        <canvas class="live-wave" id="liveWaveCanvas"></canvas>
        <div class="record-actions" id="recordActions" style="display:none">
          <audio id="previewAudio" controls style="width:100%;margin-bottom:12px;border-radius:8px;"></audio>
          <div class="rec-btn-row">
            <button class="action-btn" onclick="analyzeRecording()">üîç ANALYZE THIS</button>
            <button class="action-btn" style="background:var(--s2);color:var(--text);" onclick="protectRecording()">üîê PROTECT THIS</button>
            <button class="outline-btn" onclick="resetRecording()">‚Ü∫ REDO</button>
          </div>
        </div>
        <div class="result-card" id="recordResult" style="margin-top:16px"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PROTECT PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-protect">
      <div class="upload-zone" id="protectZone"
        onclick="document.getElementById('protectInput').click()"
        ondragover="handleDragOver(event,'protectZone')"
        ondragleave="handleDragLeave('protectZone')"
        ondrop="handleDrop(event,'protectInput','protectZone')">
        <span class="upload-icon">üéôÔ∏è</span>
        <h3>Upload original audio to watermark</h3>
        <p>Embeds an inaudible FFT signature ‚Äî sounds identical after</p>
        <input type="file" id="protectInput" accept="audio/*" style="display:none"
          onchange="onFileChosen('protectInput','protectFileLabel','protectEmbedBtn','protectWave')"/>
        <div class="file-chosen" id="protectFileLabel"></div>
      </div>
      <div class="waveform-container" id="protectWaveWrap">
        <canvas class="waveform" id="protectWave"></canvas>
      </div>
      <div class="loading-bar" id="protectLoader"></div>
      <p class="loading-text" id="protectLoaderTxt">Embedding FFT watermark‚Ä¶</p>
      <button class="action-btn" id="protectEmbedBtn" disabled onclick="runProtect()">EMBED WATERMARK</button>
      <div class="success-card" id="protectSuccess">
        <div class="big-check">‚úÖ</div>
        <h2>Watermark Embedded!</h2>
        <p id="protectSuccessMsg"></p>
        <p style="color:var(--green);font-family:var(--mono);font-size:.8rem;margin-top:8px">Download started automatically.</p>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê HISTORY PANEL ‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-history">
      <div class="history-wrap">
        <table class="htable">
          <thead>
            <tr>
              <th>File</th><th>Verdict</th><th>Confidence</th>
              <th>Duration</th><th>Time</th><th>Listen</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="6">
              <div style="padding:32px;text-align:center;color:var(--muted);font-family:var(--mono);font-size:.8rem">
                No scans yet
              </div>
            </td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="how-section">
      <h3 class="section-label">// HOW IT WORKS</h3>
      <div class="steps">
        <div class="step">
          <div class="step-num">01</div>
          <h4>FFT Transform</h4>
          <p>Audio is converted to the frequency domain via Fast Fourier Transform ‚Äî revealing the hidden frequency fingerprint.</p>
        </div>
        <div class="step">
          <div class="step-num">02</div>
          <h4>Signature Analysis</h4>
          <p>10 secret frequency bins are checked for elevated magnitude ‚Äî our invisible stamp that survives compression.</p>
        </div>
        <div class="step">
          <div class="step-num">03</div>
          <h4>Forensic Report</h4>
          <p>A confidence score is returned with a downloadable forensic report suitable for legal and evidentiary use.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <footer>Built at <span>OVERCLOCK 24</span> &nbsp;¬∑&nbsp; VoiceGuard v2.0 &nbsp;¬∑&nbsp; FFT Signal Processing &nbsp;¬∑&nbsp; Python + Flask</footer>

  <script>
    // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const TOKEN   = localStorage.getItem('vg_token');
    const DISPLAY = localStorage.getItem('vg_display') || 'User';
    const UNAME   = localStorage.getItem('vg_user') || '';

    if (!TOKEN) window.location.replace('/login.html');

    document.addEventListener('DOMContentLoaded', () => {
      const lbl = document.getElementById('userLabel');
      if (lbl) lbl.textContent = DISPLAY;
      loadStats();
      setInterval(loadStats, 12000);
    });

    function authH() { return { 'X-Token': TOKEN }; }

    function doLogout() {
      fetch('/logout', { method: 'POST', headers: authH() })
        .finally(() => { localStorage.clear(); window.location.replace('/login.html'); });
    }

    // ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function switchTab(name, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + name).classList.add('active');
      btn.classList.add('active');
      if (name === 'history') loadHistory();
    }

    // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadStats() {
      try {
        const r = await fetch('/stats', { headers: authH() });
        if (!r.ok) return;
        const d = await r.json();
        animateNum('statScans', d.total_scans || 0);
        animateNum('statFlagged', d.flagged || 0);
        animateNum('statAuth', d.authenticated || 0);
        animateNum('statProtected', d.protected || 0);
      } catch (_) {}
    }

    function animateNum(id, target) {
      const el = document.getElementById(id);
      if (!el) return;
      const cur = parseInt(el.textContent) || 0;
      if (cur === target) return;
      const step = Math.max(1, Math.ceil(Math.abs(target - cur) / 14));
      let v = cur;
      const t = setInterval(() => {
        v = v < target ? Math.min(v + step, target) : Math.max(v - step, target);
        el.textContent = v;
        if (v === target) clearInterval(t);
      }, 40);
    }

    // ‚îÄ‚îÄ File Upload Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function onFileChosen(inputId, labelId, btnId, canvasId) {
      const file = document.getElementById(inputId).files[0];
      if (!file) return;
      const lbl = document.getElementById(labelId);
      lbl.style.display = 'block';
      lbl.textContent = 'üìÅ ' + file.name;
      document.getElementById(btnId).disabled = false;
      drawStaticWave(file, canvasId);
    }

    function drawStaticWave(file, canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      canvas.parentElement.style.display = 'block';
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const ac = new (window.AudioContext || window.webkitAudioContext)();
          ac.decodeAudioData(e.target.result.slice(0), buf => {
            const data = buf.getChannelData(0);
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth || 800;
            canvas.height = 56;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const step = Math.max(1, Math.floor(data.length / canvas.width));
            for (let i = 0; i < canvas.width; i++) {
              const slice = data.slice(i * step, (i + 1) * step);
              let mx = 0;
              for (let k = 0; k < slice.length; k++) {
                const abs = Math.abs(slice[k]);
                if (abs > mx) mx = abs;
              }
              const h = mx * canvas.height;
              const g = ctx.createLinearGradient(0, (canvas.height - h) / 2, 0, (canvas.height + h) / 2);
              g.addColorStop(0, '#00e5a0');
              g.addColorStop(1, '#00e5a050');
              ctx.fillStyle = g;
              ctx.fillRect(i, (canvas.height - h) / 2, 1, h || 1);
            }
          }).catch(() => {});
        } catch (_) {}
      };
      reader.readAsArrayBuffer(file);
    }

    function handleDragOver(e, zoneId) {
      e.preventDefault();
      document.getElementById(zoneId).classList.add('dragover');
    }

    function handleDragLeave(zoneId) {
      document.getElementById(zoneId).classList.remove('dragover');
    }

    function handleDrop(e, inputId, zoneId) {
      e.preventDefault();
      document.getElementById(zoneId).classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (!files.length) return;
      const input = document.getElementById(inputId);
      try {
        const dt = new DataTransfer();
        dt.items.add(files[0]);
        input.files = dt.files;
      } catch (_) {}
      input.dispatchEvent(new Event('change'));
    }

    // ‚îÄ‚îÄ Detect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let lastResult = {};

    async function runDetect(blobArg) {
      const file = blobArg || (document.getElementById('detectInput').files[0]);
      if (!file) return;
      setLoading('detect', true);
      document.getElementById('detectResult').style.display = 'none';
      const fd = new FormData();
      fd.append('audio', file, file.name || 'recording.webm');
      try {
        const res = await fetch('/detect', { method: 'POST', body: fd, headers: authH() });
        const d = await res.json();
        lastResult = { ...d, filename: file.name || 'recorded_audio' };
        showDetectResult(d, file.name || 'recorded_audio');
        loadStats();
      } catch (_) {
        showToast('‚ùå Cannot reach Flask server. Run: python3 backend/app.py');
      } finally {
        setLoading('detect', false);
      }
    }

    function showDetectResult(d, filename) {
      const card = document.getElementById('detectResult');
      card.className = 'result-card ' + (d.color || 'yellow');
      card.style.display = 'block';
      document.getElementById('rIcon').textContent      = d.authenticated ? '‚úÖ' : '‚ùå';
      document.getElementById('rVerdict').textContent   = d.verdict || '‚Äî';
      document.getElementById('rRiskLabel').textContent = d.risk_label || '';
      document.getElementById('rRisk').textContent      = (d.risk || '‚Äî') + ' RISK';
      document.getElementById('rConf').textContent      = (d.confidence || 0) + '%';
      document.getElementById('rFile').textContent      = filename || '‚Äî';
      document.getElementById('rDuration').textContent  = d.duration_seconds ? d.duration_seconds + 's' : '‚Äî';
      document.getElementById('rScore').textContent     = d.score !== undefined ? d.score : '‚Äî';
      setTimeout(() => {
        document.getElementById('rConfFill').style.width = (d.confidence || 0) + '%';
      }, 60);
      card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // ‚îÄ‚îÄ Protect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function runProtect(blobArg) {
      const file = blobArg || (document.getElementById('protectInput').files[0]);
      if (!file) return;
      setLoading('protect', true);
      document.getElementById('protectSuccess').style.display = 'none';
      const fd = new FormData();
      fd.append('audio', file, file.name || 'recording.webm');
      try {
        const res = await fetch('/embed', { method: 'POST', body: fd, headers: authH() });
        if (!res.ok) {
          let msg = 'Embed failed';
          try { const err = await res.json(); msg = err.error || msg; } catch (_) {}
          showToast('‚ùå ' + msg);
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const fname = (file.name || 'audio').replace(/\.[^.]+$/, '');
        a.href = url;
        a.download = 'watermarked_' + fname + '.wav';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        const sc = document.getElementById('protectSuccess');
        sc.style.display = 'block';
        document.getElementById('protectSuccessMsg').textContent =
          `"${file.name || 'recording'}" is now protected.`;
        sc.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        loadStats();
      } catch (_) {
        showToast('‚ùå Cannot reach Flask server. Run: python3 backend/app.py');
      } finally {
        setLoading('protect', false);
      }
    }

    // ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setLoading(mode, on) {
      document.getElementById(mode + 'Loader').classList.toggle('active', on);
      document.getElementById(mode + 'LoaderTxt').classList.toggle('active', on);
      const btnId = mode === 'detect' ? 'detectAnalyzeBtn' : 'protectEmbedBtn';
      const btn = document.getElementById(btnId);
      if (btn) btn.disabled = on;
    }

    // ‚îÄ‚îÄ Report Download ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function downloadReport() {
      const d = lastResult;
      if (!d.verdict) { showToast('‚ö†Ô∏è Run a detection first.'); return; }
      const lines = [
        '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó',
        '‚ïë      VOICEGUARD FORENSIC REPORT          ‚ïë',
        '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù',
        '',
        `Generated  : ${new Date().toLocaleString()}`,
        `Analyst    : ${DISPLAY} (@${UNAME})`,
        '',
        '‚îÄ‚îÄ AUDIO FILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
        `File       : ${d.filename || '‚Äî'}`,
        `Duration   : ${d.duration_seconds ? d.duration_seconds + 's' : '‚Äî'}`,
        `Sample Rate: ${d.sample_rate ? d.sample_rate + ' Hz' : '‚Äî'}`,
        '',
        '‚îÄ‚îÄ RESULT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
        `Verdict    : ${d.verdict}`,
        `Authenticated: ${d.authenticated ? 'YES' : 'NO'}`,
        `Confidence : ${d.confidence}%`,
        `FFT Score  : ${d.score}`,
        `Risk Level : ${d.risk}`,
        '',
        '‚îÄ‚îÄ TECHNICAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
        'Method     : Fast Fourier Transform (FFT)',
        'Key Bins   : [42,137,256,389,512,701,1024,1337,2048,2500]',
        'Threshold  : 1.4',
        '',
        'VoiceGuard v2.0 ¬∑ OVERCLOCK 24'
      ];
      const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `vg_report_${Date.now()}.txt`;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    // ‚îÄ‚îÄ Live Recording ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const liveRec = {
      recorder: null, chunks: [], blob: null,
      recording: false, timer: null, elapsed: 0,
      stream: null, audioCtx: null
    };
    const BIG_C = 452.4, MAX_R = 8;

    async function toggleLiveRecord() {
      liveRec.recording ? stopLiveRecord() : await startLiveRecord();
    }

    async function startLiveRecord() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        liveRec.stream  = stream;
        liveRec.chunks  = [];
        liveRec.blob    = null;
        liveRec.elapsed = 0;

        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
          ? 'audio/webm;codecs=opus'
          : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
        const opts = mimeType ? { mimeType } : {};

        liveRec.recorder = new MediaRecorder(stream, opts);
        liveRec.recorder.ondataavailable = e => {
          if (e.data && e.data.size > 0) liveRec.chunks.push(e.data);
        };
        liveRec.recorder.onstop = () => {
          liveRec.blob = new Blob(liveRec.chunks, { type: liveRec.recorder.mimeType || 'audio/webm' });
          stream.getTracks().forEach(t => t.stop());
          if (liveRec.audioCtx) { liveRec.audioCtx.close(); liveRec.audioCtx = null; }
          onLiveDone();
        };
        liveRec.recorder.start(100);
        liveRec.recording = true;

        const btn = document.getElementById('bigMicBtn');
        btn.classList.add('recording');
        btn.classList.remove('done');
        document.getElementById('bigMicIcon').textContent = '‚èπÔ∏è';
        document.getElementById('recHint').textContent = 'üî¥ Recording‚Ä¶ speak clearly';

        drawBigWave(stream);

        liveRec.timer = setInterval(() => {
          liveRec.elapsed += 0.1;
          document.getElementById('recTimeDisplay').textContent = liveRec.elapsed.toFixed(1) + 's';
          document.getElementById('bigRingFill').style.strokeDashoffset =
            BIG_C * (1 - Math.min(liveRec.elapsed / MAX_R, 1));
          if (liveRec.elapsed >= MAX_R) stopLiveRecord();
        }, 100);
      } catch (err) {
        showToast('‚ùå Microphone access denied.');
      }
    }

    function stopLiveRecord() {
      if (!liveRec.recording) return;
      liveRec.recording = false;
      clearInterval(liveRec.timer);
      if (liveRec.recorder && liveRec.recorder.state !== 'inactive') liveRec.recorder.stop();
    }

    function onLiveDone() {
      const btn = document.getElementById('bigMicBtn');
      btn.classList.remove('recording');
      btn.classList.add('done');
      document.getElementById('bigMicIcon').textContent = '‚úÖ';
      document.getElementById('recHint').textContent = `${liveRec.elapsed.toFixed(1)}s recorded ‚Äî ready`;
      document.getElementById('bigRingFill').style.strokeDashoffset = 0;
      const previewAudio = document.getElementById('previewAudio');
      previewAudio.src = URL.createObjectURL(liveRec.blob);
      document.getElementById('recordActions').style.display = 'block';
      document.getElementById('liveWaveCanvas').style.display = 'none';
    }

    function drawBigWave(stream) {
      const canvas = document.getElementById('liveWaveCanvas');
      canvas.style.display = 'block';
      const ctx = canvas.getContext('2d');
      try {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        liveRec.audioCtx = ac;
        const src = ac.createMediaStreamSource(stream);
        const ana = ac.createAnalyser();
        ana.fftSize = 64;
        src.connect(ana);
        const data = new Uint8Array(ana.frequencyBinCount);
        function draw() {
          if (!liveRec.recording) { ctx.clearRect(0, 0, canvas.width, canvas.height); return; }
          requestAnimationFrame(draw);
          ana.getByteFrequencyData(data);
          canvas.width = canvas.offsetWidth || 600;
          canvas.height = 48;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const bw = canvas.width / data.length;
          data.forEach((v, i) => {
            const h = (v / 255) * canvas.height;
            const g = ctx.createLinearGradient(0, canvas.height - h, 0, canvas.height);
            g.addColorStop(0, '#00e5a0');
            g.addColorStop(1, '#00e5a020');
            ctx.fillStyle = g;
            ctx.fillRect(i * bw, canvas.height - h, bw - 1, h);
          });
        }
        draw();
      } catch(_) {}
    }

    async function analyzeRecording() {
      if (!liveRec.blob) return;
      const rc = document.getElementById('recordResult');
      rc.className = 'result-card yellow';
      rc.style.display = 'block';
      rc.innerHTML = '<div style="font-family:var(--mono);font-size:.8rem;color:var(--muted);padding:10px">‚è≥ Analyzing‚Ä¶</div>';
      const fd = new FormData();
      fd.append('audio', liveRec.blob, 'recording.webm');
      try {
        const res = await fetch('/detect', { method: 'POST', body: fd, headers: authH() });
        const d = await res.json();
        lastResult = { ...d, filename: 'live_recording' };
        // Show result inline in record panel
        const color = d.color || 'yellow';
        rc.className = 'result-card ' + color;
        rc.innerHTML = `
          <div class="verdict-row">
            <div class="verdict-badge">
              <div class="vicon">${d.authenticated ? '‚úÖ' : '‚ùå'}</div>
              <div class="vtext"><h2>${d.verdict || '‚Äî'}</h2><p>${d.risk_label || ''}</p></div>
            </div>
            <div class="risk-pill">${d.risk || '‚Äî'} RISK</div>
          </div>
          <div class="conf-section">
            <div class="conf-labels"><span>CONFIDENCE</span><span>${d.confidence || 0}%</span></div>
            <div class="conf-track"><div class="conf-fill" id="rcFill" style="width:0%"></div></div>
          </div>`;
        setTimeout(() => {
          const f = document.getElementById('rcFill');
          if (f) f.style.width = (d.confidence || 0) + '%';
        }, 60);
        loadStats();
      } catch (_) {
        showToast('‚ùå Cannot reach Flask server.');
      }
    }

    async function protectRecording() {
      if (!liveRec.blob) return;
      // Create a file-like blob with a name
      const namedBlob = new File([liveRec.blob], 'recording.webm', { type: liveRec.blob.type });
      await runProtect(namedBlob);
    }

    function resetRecording() {
      liveRec.blob = null; liveRec.elapsed = 0;
      const btn = document.getElementById('bigMicBtn');
      btn.classList.remove('recording', 'done');
      document.getElementById('bigMicIcon').textContent = 'üéôÔ∏è';
      document.getElementById('recHint').textContent = 'Click to start recording';
      document.getElementById('recTimeDisplay').textContent = '0.0s';
      document.getElementById('bigRingFill').style.strokeDashoffset = BIG_C;
      document.getElementById('recordActions').style.display = 'none';
      document.getElementById('recordResult').style.display = 'none';
      document.getElementById('liveWaveCanvas').style.display = 'none';
      const pa = document.getElementById('previewAudio');
      if (pa.src) { URL.revokeObjectURL(pa.src); pa.src = ''; }
    }

    // ‚îÄ‚îÄ History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const audioInst = {};

    async function loadHistory() {
      try {
        const res = await fetch('/history', { headers: authH() });
        if (!res.ok) return;
        const rows = await res.json();
        const tbody = document.getElementById('historyBody');
        if (!Array.isArray(rows) || !rows.length) {
          tbody.innerHTML = '<tr><td colspan="6"><div style="padding:32px;text-align:center;color:var(--muted);font-family:var(--mono);font-size:.8rem">No scans yet</div></td></tr>';
          return;
        }
        tbody.innerHTML = rows.map(r => {
          const ok = r.verdict === 'WATERMARK DETECTED';
          const hasAudio = !!r.stored_filename;
          const ts = new Date(r.timestamp + (r.timestamp.includes('Z') ? '' : 'Z')).toLocaleTimeString();
          const ds = r.duration ? parseFloat(r.duration).toFixed(1) + 's' : '‚Äî';
          const rowId = r.id;
          return `<tr>
            <td>
              <div class="hrow-main" onclick="togglePlayer(${rowId},${hasAudio})">
                <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${r.filename}">${r.filename || '‚Äî'}</span>
                <span><span class="verdict-pill ${ok ? 'ok' : 'bad'}">${ok ? '‚úÖ AUTHENTIC' : '‚ùå TAMPERED'}</span></span>
                <span>${r.confidence || 0}%</span>
                <span style="color:var(--muted)">${ds}</span>
                <span style="color:var(--muted)">${ts}</span>
                <span>${hasAudio
                  ? `<button class="play-btn" id="playbtn-${rowId}" onclick="event.stopPropagation();togglePlayer(${rowId},true)">‚ñ∂ Play</button>`
                  : '<span style="color:var(--muted)">‚Äî</span>'
                }</span>
              </div>
              <div class="player-row" id="player-${rowId}">
                <div class="audio-player">
                  <div class="player-header">
                    <span class="player-fname">üéµ ${r.filename || '‚Äî'}</span>
                    <span class="player-dur" id="dur-${rowId}">0:00 / ${ds}</span>
                  </div>
                  <div class="player-ctrl">
                    <button class="ctrl-btn main" id="pp-${rowId}" onclick="togglePlay(${rowId})">‚ñ∂</button>
                    <div class="prog-area">
                      <div class="prog-wrap" onclick="seekAudio(event,${rowId})">
                        <div class="prog-fill" id="pfill-${rowId}"></div>
                        <div class="prog-thumb" id="pthumb-${rowId}"></div>
                      </div>
                      <div class="time-row">
                        <span id="tcur-${rowId}">0:00</span>
                        <span id="tend-${rowId}">${ds}</span>
                      </div>
                    </div>
                    <div class="vol-wrap">
                      <span>üîä</span>
                      <input type="range" class="vol-slider" min="0" max="1" step="0.05" value="1"
                        oninput="setVol(${rowId},this.value)">
                    </div>
                  </div>
                </div>
              </div>
            </td>
          </tr>`;
        }).join('');
      } catch (_) {}
    }

    function togglePlayer(id, hasAudio) {
      if (!hasAudio) return;
      const row = document.getElementById(`player-${id}`);
      if (!row) return;
      const isOpen = row.classList.contains('open');
      // Close all others
      document.querySelectorAll('.player-row.open').forEach(r => {
        const oid = parseInt(r.id.replace('player-', ''));
        if (oid !== id) closePlayer(oid);
      });
      isOpen ? closePlayer(id) : openPlayer(id);
    }

    function openPlayer(id) {
      const row = document.getElementById(`player-${id}`);
      if (row) row.classList.add('open');
      const btn = document.getElementById(`playbtn-${id}`);
      if (btn) { btn.classList.add('playing'); btn.textContent = '‚ñ† Close'; }
      loadAudio(id);
    }

    function closePlayer(id) {
      const row = document.getElementById(`player-${id}`);
      if (row) row.classList.remove('open');
      const btn = document.getElementById(`playbtn-${id}`);
      if (btn) { btn.classList.remove('playing'); btn.textContent = '‚ñ∂ Play'; }
      stopAudio(id);
    }

    function loadAudio(id) {
      if (audioInst[id]) return;
      const audio = new Audio(`/audio/${id}`);
      audio.volume = 1;
      audioInst[id] = audio;

      audio.addEventListener('timeupdate', () => {
        if (!audio.duration) return;
        const pct = (audio.currentTime / audio.duration) * 100;
        const fi = document.getElementById(`pfill-${id}`);
        const th = document.getElementById(`pthumb-${id}`);
        const tc = document.getElementById(`tcur-${id}`);
        const du = document.getElementById(`dur-${id}`);
        if (fi) fi.style.width = pct + '%';
        if (th) th.style.left = pct + '%';
        if (tc) tc.textContent = fmtTime(audio.currentTime);
        if (du) du.textContent = fmtTime(audio.currentTime) + ' / ' + fmtTime(audio.duration);
      });

      audio.addEventListener('ended', () => {
        const pp = document.getElementById(`pp-${id}`);
        if (pp) pp.textContent = '‚ñ∂';
      });

      audio.addEventListener('loadedmetadata', () => {
        const te = document.getElementById(`tend-${id}`);
        const du = document.getElementById(`dur-${id}`);
        if (te) te.textContent = fmtTime(audio.duration);
        if (du) du.textContent = '0:00 / ' + fmtTime(audio.duration);
      });
    }

    function togglePlay(id) {
      const audio = audioInst[id];
      if (!audio) { loadAudio(id); setTimeout(() => togglePlay(id), 300); return; }
      const pp = document.getElementById(`pp-${id}`);
      if (audio.paused) {
        // Pause all others
        Object.entries(audioInst).forEach(([oid, au]) => {
          if (parseInt(oid) !== id && !au.paused) {
            au.pause();
            const ob = document.getElementById(`pp-${oid}`);
            if (ob) ob.textContent = '‚ñ∂';
          }
        });
        audio.play().catch(() => {});
        if (pp) pp.textContent = '‚è∏';
      } else {
        audio.pause();
        if (pp) pp.textContent = '‚ñ∂';
      }
    }

    function stopAudio(id) {
      const audio = audioInst[id];
      if (!audio) return;
      audio.pause();
      audio.currentTime = 0;
      const pp = document.getElementById(`pp-${id}`);
      if (pp) pp.textContent = '‚ñ∂';
    }

    function seekAudio(e, id) {
      const audio = audioInst[id];
      if (!audio || !audio.duration) return;
      const rect = e.currentTarget.getBoundingClientRect();
      audio.currentTime = ((e.clientX - rect.left) / rect.width) * audio.duration;
    }

    function setVol(id, v) {
      const audio = audioInst[id];
      if (audio) audio.volume = parseFloat(v);
    }

    function fmtTime(s) {
      if (!s || isNaN(s)) return '0:00';
      return `${Math.floor(s / 60)}:${String(Math.floor(s % 60)).padStart(2, '0')}`;
    }

    // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3500);
    }
  </script>
</body>
</html>
