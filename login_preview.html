<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VoiceGuard ‚Äî Voice Login</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg:#060910;--surface:#0d1117;--s2:#111820;--border:#1a2535;
      --green:#00e5a0;--g10:#00e5a010;--g20:#00e5a020;--g40:#00e5a040;
      --red:#ff4560;--text:#e2e8f0;--muted:#4a5568;
      --mono:'Space Mono',monospace;--sans:'Syne',sans-serif
    }
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--sans);overflow-x:hidden}
    .grid-bg{position:fixed;inset:0;z-index:0;
      background:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
      background-size:52px 52px;
      mask-image:radial-gradient(ellipse 70% 70% at 50% 50%,black,transparent);
      -webkit-mask-image:radial-gradient(ellipse 70% 70% at 50% 50%,black,transparent);
      opacity:.2}
    .particles{position:fixed;inset:0;z-index:0;pointer-events:none}
    .particle{position:absolute;width:2px;height:2px;background:var(--green);border-radius:50%;opacity:0;animation:floatUp linear infinite}
    @keyframes floatUp{0%{opacity:0;transform:translateY(0) scale(1)}10%{opacity:.6}90%{opacity:.3}100%{opacity:0;transform:translateY(-100vh) scale(.3)}}
    .login-wrap{position:relative;z-index:1;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px}
    .logo-block{text-align:center;margin-bottom:28px;animation:fadeDown .6s ease both}
    .logo-icon{font-size:2.8rem;margin-bottom:8px;animation:glow 3s ease-in-out infinite;display:block}
    @keyframes glow{0%,100%{filter:drop-shadow(0 0 16px var(--green))}50%{filter:drop-shadow(0 0 32px var(--green))}}
    .logo-block h1{font-size:3rem;font-weight:800;letter-spacing:-2px;color:var(--text)}
    .logo-block h1 span{color:var(--green)}
    .tagline{font-family:var(--mono);font-size:.75rem;color:var(--muted);letter-spacing:2px;margin-top:6px}
    @keyframes fadeDown{from{opacity:0;transform:translateY(-16px)}to{opacity:1;transform:translateY(0)}}
    .mode-toggle{display:flex;gap:4px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:4px;margin-bottom:16px;animation:fadeDown .6s .1s ease both}
    .mode-btn{flex:1;padding:10px 28px;border:none;border-radius:7px;background:transparent;color:var(--muted);font-family:var(--mono);font-size:.75rem;letter-spacing:2px;cursor:pointer;transition:all .2s}
    .mode-btn.active{background:var(--green);color:#000;font-weight:700}
    .mode-btn:not(.active):hover{color:var(--text);background:var(--s2)}
    .card{width:100%;max-width:520px;background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;animation:fadeDown .6s .15s ease both;box-shadow:0 24px 80px #00000060,0 0 0 1px var(--g10)}
    .form-section{display:flex;flex-direction:column;gap:20px}
    .form-section.hidden{display:none}
    .field{display:flex;flex-direction:column;gap:6px}
    .field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field label{font-family:var(--mono);font-size:.65rem;letter-spacing:2px;color:var(--muted);text-transform:uppercase}
    .field input{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:var(--mono);font-size:.85rem;outline:none;transition:border-color .2s}
    .field input:focus{border-color:var(--green)}
    .field input::placeholder{color:var(--muted)}
    .voice-section{display:flex;flex-direction:column;align-items:center;gap:10px;padding:24px;background:var(--s2);border:1px solid var(--border);border-radius:16px}
    .voice-label{font-family:var(--mono);font-size:.7rem;letter-spacing:2px;color:var(--green)}
    .voice-hint{font-size:.78rem;color:var(--muted);text-align:center;max-width:280px;line-height:1.5}
    .mic-ring{position:relative;width:120px;height:120px;display:flex;align-items:center;justify-content:center;margin:8px 0}
    .ring-svg{position:absolute;inset:0;width:100%;height:100%;transform:rotate(-90deg)}
    .ring-track{fill:none;stroke:var(--border);stroke-width:4}
    .ring-fill{fill:none;stroke:var(--green);stroke-width:4;stroke-linecap:round;stroke-dasharray:339.3;stroke-dashoffset:339.3;transition:stroke-dashoffset .1s linear}
    .mic-btn{width:76px;height:76px;border-radius:50%;background:var(--bg);border:2px solid var(--border);cursor:pointer;transition:all .25s;display:flex;align-items:center;justify-content:center;position:relative;z-index:1}
    .mic-btn:hover{border-color:var(--green);background:var(--g10)}
    .mic-btn.recording{background:#1a0000;border-color:var(--red);animation:micPulse 1s ease-in-out infinite}
    .mic-btn.recorded{background:var(--g10);border-color:var(--green)}
    @keyframes micPulse{0%,100%{box-shadow:0 0 0 0 rgba(255,69,96,.4)}50%{box-shadow:0 0 0 14px rgba(255,69,96,0)}}
    .mic-icon{font-size:1.8rem}
    .rec-status{font-family:var(--mono);font-size:.72rem;color:var(--muted);text-align:center}
    .wavebar{width:100%;height:40px;border-radius:6px;display:none}
    .submit-btn{width:100%;padding:16px;background:var(--green);color:#000;border:none;border-radius:12px;font-family:var(--mono);font-size:.9rem;font-weight:700;letter-spacing:2px;cursor:pointer;transition:all .2s;text-transform:uppercase}
    .submit-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 8px 28px var(--g40)}
    .submit-btn:disabled{background:var(--s2);color:var(--muted);cursor:not-allowed}
    .result-area{min-height:10px}
    .result-card{padding:18px 20px;border-radius:12px;border:1px solid;animation:popIn .35s cubic-bezier(.175,.885,.32,1.275) both}
    @keyframes popIn{from{opacity:0;transform:scale(.94)}to{opacity:1;transform:scale(1)}}
    .result-card.success{background:#0a1a10;border-color:#00e5a060}
    .result-card.error{background:#1a080a;border-color:#ff456060}
    .result-card .verdict{font-family:var(--mono);font-size:1rem;font-weight:700;margin-bottom:8px}
    .result-card.success .verdict{color:var(--green)}
    .result-card.error .verdict{color:var(--red)}
    .result-card .sub{font-size:.8rem;color:var(--muted);font-family:var(--mono)}
    .conf-bar{height:4px;background:var(--border);border-radius:2px;margin-top:10px;overflow:hidden}
    .conf-fill{height:100%;border-radius:2px;transition:width .8s ease}
    .success .conf-fill{background:var(--green)}
    .error .conf-fill{background:var(--red)}
    .spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .7s linear infinite;margin-right:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
    .footer-note{margin-top:20px;font-family:var(--mono);font-size:.65rem;color:var(--muted);letter-spacing:1px;animation:fadeDown .6s .3s ease both;text-align:center}
    @media(max-width:480px){.card{padding:20px}.field-row{grid-template-columns:1fr}.logo-block h1{font-size:2.2rem}}
  </style>
</head>
<body>
  <div class="grid-bg"></div>
  <div class="particles" id="particles"></div>
  <div class="login-wrap">
    <div class="logo-block">
      <span class="logo-icon">üîê</span>
      <h1>VOICE<span>GUARD</span></h1>
      <p class="tagline">// Your Voice Is Your Password</p>
    </div>
    <div class="mode-toggle">
      <button class="mode-btn active" id="btnLogin" onclick="setMode('login')">LOGIN</button>
      <button class="mode-btn" id="btnRegister" onclick="setMode('register')">REGISTER</button>
    </div>
    <div class="card">
      <!-- LOGIN -->
      <div class="form-section" id="sectionLogin">
        <div class="field">
          <label>Username</label>
          <input type="text" id="loginUsername" placeholder="your username" autocomplete="off"/>
        </div>
        <div class="voice-section">
          <p class="voice-label">SPEAK YOUR PASSPHRASE</p>
          <p class="voice-hint">Say your name or a memorable phrase clearly</p>
          <div class="mic-ring">
            <button class="mic-btn" id="loginMicBtn" onclick="toggleRecord('login')">
              <span class="mic-icon" id="loginMicIcon">üéôÔ∏è</span>
            </button>
            <svg class="ring-svg" viewBox="0 0 120 120">
              <circle class="ring-track" cx="60" cy="60" r="54"/>
              <circle class="ring-fill" id="loginRingFill" cx="60" cy="60" r="54"/>
            </svg>
          </div>
          <p class="rec-status" id="loginStatus">Click the mic to start speaking</p>
          <canvas class="wavebar" id="loginWave"></canvas>
        </div>
        <button class="submit-btn" id="loginSubmit" onclick="submitLogin()" disabled>VERIFY VOICE</button>
        <div class="result-area" id="loginResult"></div>
      </div>
      <!-- REGISTER -->
      <div class="form-section hidden" id="sectionRegister">
        <div class="field-row">
          <div class="field">
            <label>Username</label>
            <input type="text" id="regUsername" placeholder="choose a username" autocomplete="off"/>
          </div>
          <div class="field">
            <label>Display Name</label>
            <input type="text" id="regDisplayName" placeholder="your name" autocomplete="off"/>
          </div>
        </div>
        <div class="voice-section">
          <p class="voice-label">RECORD YOUR VOICE</p>
          <p class="voice-hint">Speak clearly for 3‚Äì5 seconds. This becomes your biometric key.</p>
          <div class="mic-ring">
            <button class="mic-btn" id="registerMicBtn" onclick="toggleRecord('register')">
              <span class="mic-icon" id="registerMicIcon">üéôÔ∏è</span>
            </button>
            <svg class="ring-svg" viewBox="0 0 120 120">
              <circle class="ring-track" cx="60" cy="60" r="54"/>
              <circle class="ring-fill" id="registerRingFill" cx="60" cy="60" r="54"/>
            </svg>
          </div>
          <p class="rec-status" id="registerStatus">Click the mic to record your voice</p>
          <canvas class="wavebar" id="registerWave"></canvas>
        </div>
        <button class="submit-btn" id="registerSubmit" onclick="submitRegister()" disabled>REGISTER VOICE</button>
        <div class="result-area" id="registerResult"></div>
      </div>
    </div>
    <p class="footer-note">VoiceGuard v2.0 &nbsp;¬∑&nbsp; OVERCLOCK 24 &nbsp;¬∑&nbsp; FFT + MFCC Signal Processing</p>
  </div>

  <script>
    const MAX_SECONDS = 6;
    const state = {
      login:    { recorder: null, chunks: [], blob: null, recording: false, timer: null, elapsed: 0, audioCtx: null },
      register: { recorder: null, chunks: [], blob: null, recording: false, timer: null, elapsed: 0, audioCtx: null }
    };

    // Redirect if already logged in
    if (localStorage.getItem('vg_token')) window.location.replace('/');

    // Generate floating particles
    (function() {
      const c = document.getElementById('particles');
      for (let i = 0; i < 30; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.cssText = `left:${Math.random()*100}%;bottom:${Math.random()*-20}%;` +
          `animation-duration:${4+Math.random()*8}s;animation-delay:${Math.random()*6}s;` +
          `width:${1+Math.random()*2}px;height:${1+Math.random()*2}px;`;
        c.appendChild(p);
      }
    })();

    function setMode(m) {
      document.getElementById('sectionLogin').classList.toggle('hidden', m !== 'login');
      document.getElementById('sectionRegister').classList.toggle('hidden', m !== 'register');
      document.getElementById('btnLogin').classList.toggle('active', m === 'login');
      document.getElementById('btnRegister').classList.toggle('active', m === 'register');
    }

    async function toggleRecord(m) {
      state[m].recording ? stopRecording(m) : await startRecording(m);
    }

    async function startRecording(m) {
      const s = state[m];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        s.chunks = []; s.blob = null; s.elapsed = 0;

        // Determine supported mimeType
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
          ? 'audio/webm;codecs=opus'
          : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
        const opts = mimeType ? { mimeType } : {};

        s.recorder = new MediaRecorder(stream, opts);
        s.recorder.ondataavailable = e => { if (e.data && e.data.size > 0) s.chunks.push(e.data); };
        s.recorder.onstop = () => {
          s.blob = new Blob(s.chunks, { type: s.recorder.mimeType || 'audio/webm' });
          stream.getTracks().forEach(t => t.stop());
          if (s.audioCtx) { s.audioCtx.close(); s.audioCtx = null; }
          onDone(m);
        };
        s.recorder.start(100);
        s.recording = true;
        setUI(m, true);
        drawWave(m, stream);
        s.timer = setInterval(() => {
          s.elapsed += 0.1;
          updateRing(m, s.elapsed / MAX_SECONDS);
          document.getElementById(m + 'Status').textContent = `üî¥ Recording‚Ä¶ ${s.elapsed.toFixed(1)}s`;
          if (s.elapsed >= MAX_SECONDS) stopRecording(m);
        }, 100);
      } catch (err) {
        setStatus(m, '‚ùå Mic access denied. Allow microphone in browser settings.', 'red');
      }
    }

    function stopRecording(m) {
      const s = state[m];
      if (!s.recording) return;
      s.recording = false;
      clearInterval(s.timer);
      if (s.recorder && s.recorder.state !== 'inactive') s.recorder.stop();
      setUI(m, false);
    }

    function onDone(m) {
      setStatus(m, `‚úÖ ${state[m].elapsed.toFixed(1)}s recorded ‚Äî ready to submit`, 'green');
      document.getElementById(m + 'MicBtn').classList.add('recorded');
      document.getElementById(m + 'MicIcon').textContent = '‚úÖ';
      const submitId = m === 'login' ? 'loginSubmit' : 'registerSubmit';
      document.getElementById(submitId).disabled = false;
      updateRing(m, 1);
      // hide canvas
      document.getElementById(m + 'Wave').style.display = 'none';
    }

    function drawWave(m, stream) {
      const canvas = document.getElementById(m + 'Wave');
      canvas.style.display = 'block';
      canvas.width = canvas.offsetWidth || 300;
      canvas.height = 40;
      const ctx = canvas.getContext('2d');
      try {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        state[m].audioCtx = ac;
        const src = ac.createMediaStreamSource(stream);
        const ana = ac.createAnalyser();
        ana.fftSize = 64;
        src.connect(ana);
        const data = new Uint8Array(ana.frequencyBinCount);
        function draw() {
          if (!state[m].recording) { ctx.clearRect(0, 0, canvas.width, canvas.height); return; }
          requestAnimationFrame(draw);
          ana.getByteFrequencyData(data);
          canvas.width = canvas.offsetWidth || 300;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const bw = canvas.width / data.length;
          data.forEach((v, i) => {
            const h = (v / 255) * canvas.height;
            const g = ctx.createLinearGradient(0, canvas.height - h, 0, canvas.height);
            g.addColorStop(0, '#00e5a0');
            g.addColorStop(1, '#00e5a030');
            ctx.fillStyle = g;
            ctx.fillRect(i * bw, canvas.height - h, bw - 1, h);
          });
        }
        draw();
      } catch(e) { /* AudioContext not available */ }
    }

    function updateRing(m, pct) {
      const fill = document.getElementById(m + 'RingFill');
      if (fill) fill.style.strokeDashoffset = 339.3 * (1 - Math.min(pct, 1));
    }

    function setUI(m, rec) {
      const btn = document.getElementById(m + 'MicBtn');
      btn.classList.toggle('recording', rec);
      if (!rec) btn.classList.remove('recorded');
      document.getElementById(m + 'MicIcon').textContent = rec ? '‚èπÔ∏è' : 'üéôÔ∏è';
    }

    function setStatus(m, text, col = 'muted') {
      const el = document.getElementById(m + 'Status');
      el.textContent = text;
      el.style.color = col === 'green' ? 'var(--green)' : col === 'red' ? 'var(--red)' : 'var(--muted)';
    }

    function setResult(m, html) {
      document.getElementById(m + 'Result').innerHTML = html;
    }

    function errCard(msg, conf = 0) {
      return `<div class="result-card error">
        <div class="verdict">‚ùå ${msg}</div>
        ${conf ? `<div class="conf-bar"><div class="conf-fill" style="width:${conf}%"></div></div>` : ''}
      </div>`;
    }

    async function submitLogin() {
      const username = (document.getElementById('loginUsername').value || '').trim().toLowerCase();
      const blob = state.login.blob;
      if (!username) { setResult('login', errCard('Please enter your username.')); return; }
      if (!blob) { setResult('login', errCard('Please record your voice first.')); return; }
      const btn = document.getElementById('loginSubmit');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>VERIFYING‚Ä¶';
      const fd = new FormData();
      fd.append('username', username);
      fd.append('audio', blob, 'voice.webm');
      try {
        const res = await fetch('/login', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.matched) {
          localStorage.setItem('vg_token', data.token);
          localStorage.setItem('vg_user', data.username);
          localStorage.setItem('vg_display', data.display_name);
          setResult('login', `<div class="result-card success">
            <div class="verdict">‚úÖ VOICE VERIFIED</div>
            <div class="sub">Welcome back, ${data.display_name} ¬∑ Match: ${data.confidence}%</div>
            <div class="conf-bar"><div class="conf-fill" style="width:${data.confidence}%"></div></div>
          </div>`);
          setTimeout(() => window.location.replace('/'), 1200);
        } else {
          setResult('login', errCard(data.error || 'Voice not recognised. Try again.', data.confidence || 0));
          btn.disabled = false;
          btn.textContent = 'VERIFY VOICE';
        }
      } catch (e) {
        setResult('login', errCard('Cannot reach server. Make sure Flask is running.'));
        btn.disabled = false;
        btn.textContent = 'VERIFY VOICE';
      }
    }

    async function submitRegister() {
      const username = (document.getElementById('regUsername').value || '').trim().toLowerCase();
      const displayName = (document.getElementById('regDisplayName').value || '').trim();
      const blob = state.register.blob;
      if (!username) { setResult('register', errCard('Please enter a username.')); return; }
      if (!blob) { setResult('register', errCard('Please record your voice first.')); return; }
      const btn = document.getElementById('registerSubmit');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>REGISTERING‚Ä¶';
      const fd = new FormData();
      fd.append('username', username);
      fd.append('display_name', displayName || username);
      fd.append('audio', blob, 'voice.webm');
      try {
        const res = await fetch('/register', { method: 'POST', body: fd });
        const data = await res.json();
        if (data.success) {
          localStorage.setItem('vg_token', data.token);
          localStorage.setItem('vg_user', data.username);
          localStorage.setItem('vg_display', data.display_name);
          setResult('register', `<div class="result-card success">
            <div class="verdict">‚úÖ VOICE REGISTERED</div>
            <div class="sub">${data.message}</div>
            <div class="conf-bar"><div class="conf-fill" style="width:100%"></div></div>
          </div>`);
          setTimeout(() => window.location.replace('/'), 1400);
        } else {
          setResult('register', errCard(data.error || 'Registration failed.'));
          btn.disabled = false;
          btn.textContent = 'REGISTER VOICE';
        }
      } catch (e) {
        setResult('register', errCard('Cannot reach server. Make sure Flask is running.'));
        btn.disabled = false;
        btn.textContent = 'REGISTER VOICE';
      }
    }
  </script>
</body>
</html>
